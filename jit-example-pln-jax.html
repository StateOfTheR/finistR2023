<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hugo Gangloff">

<title>Finist’R 2023 - FinistR : bootcamp R à Roscoff</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "Pas de résultats",
    "search-matching-documents-text": "documents trouvés",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Finist’R 2023</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Recherche"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Basculer la navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/StateOfTheR/finistR2023" rel="" target=""><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./instructions.html" rel="" target="">
 <span class="menu-text">Instructions</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-enseignement" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Enseignement</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-enseignement">    
        <li>
    <a class="dropdown-item" href="./learnr.html" rel="" target="">
 <span class="dropdown-text">Learnr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./exams.html" rel="" target="">
 <span class="dropdown-text">exams</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-workflow" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Workflow</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-workflow">    
        <li>
    <a class="dropdown-item" href="./Utilisation_de_git.html" rel="" target="">
 <span class="dropdown-text">Initiation à Git</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./how_to_maintain_a_dockerfile.html" rel="" target="">
 <span class="dropdown-text">Maintenir un docker multi-langage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./issue_reprex.html" rel="" target="">
 <span class="dropdown-text">Issue - Reprex</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-analyse-statistique" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Analyse statistique</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-analyse-statistique">    
        <li>
    <a class="dropdown-item" href="./R_INLA.html" rel="" target="">
 <span class="dropdown-text">INLA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./tidymodels_build_new_model.html" rel="" target="">
 <span class="dropdown-text">Nouveau modèle Parsnip</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./torch_test-brulee.html" rel="" target="">
 <span class="dropdown-text"><code>{torch}</code> avec <code>{tidymodels}</code> et <code>{brulee}</code></span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-programmation-efficace" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Programmation Efficace</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-programmation-efficace">    
        <li>
    <a class="dropdown-item" href="./torch_Python_R_ResNet.html" rel="" target="">
 <span class="dropdown-text"><em>ResNet</em> : comparaison <code>{torch}</code> et <code>pytorch</code></span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./torch_Python_regression.html" rel="" target="">
 <span class="dropdown-text">Introduction à Pytorch</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Intel_MKL.html" rel="" target="">
 <span class="dropdown-text">Intel MKL &amp; Open Blas</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./torch_and_rcpp.html" rel="" target="">
 <span class="dropdown-text">Torch &amp; Rcpp</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./jax-getting-started.html" rel="" target="">
 <span class="dropdown-text">Premiers pas avec jax</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-autour-de-pln" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Autour de PLN</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-autour-de-pln">    
        <li>
    <a class="dropdown-item" href="./torch_R_PLN.html" rel="" target="">
 <span class="dropdown-text">PLN version R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./torch_Python-PLN.html" rel="" target="">
 <span class="dropdown-text">PLN version Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./jit-example-pln-jax.html" rel="" target="">
 <span class="dropdown-text">FinistR : bootcamp R à Roscoff</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./jit-example-pln.html" rel="" target="">
 <span class="dropdown-text">JIT with pytorch</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sur cette page</h2>
   
  <ul>
  <li><a href="#jit-with-jax" id="toc-jit-with-jax" class="nav-link active" data-scroll-target="#jit-with-jax">JIT with JAX</a>
  <ul class="collapse">
  <li><a href="#jax-without-jit" id="toc-jax-without-jit" class="nav-link" data-scroll-target="#jax-without-jit">JAX without JIT</a></li>
  <li><a href="#jit-with-jax-level-1-jax.jit" id="toc-jit-with-jax-level-1-jax.jit" class="nav-link" data-scroll-target="#jit-with-jax-level-1-jax.jit">JIT with JAX level 1: <code>jax.jit</code></a></li>
  <li><a href="#jit-with-jax-level-2-jax.lax.scan" id="toc-jit-with-jax-level-2-jax.lax.scan" class="nav-link" data-scroll-target="#jit-with-jax-level-2-jax.lax.scan">JIT with JAX level 2: <code>jax.lax.scan</code></a></li>
  <li><a href="#jit-with-jax-level-3-can-we-jit-everything" id="toc-jit-with-jax-level-3-can-we-jit-everything" class="nav-link" data-scroll-target="#jit-with-jax-level-3-can-we-jit-everything">JIT with JAX level 3: can we jit everything?</a></li>
  <li><a href="#jit-with-jax-level-4-jit-on-class-methods" id="toc-jit-with-jax-level-4-jit-on-class-methods" class="nav-link" data-scroll-target="#jit-with-jax-level-4-jit-on-class-methods">JIT with JAX level 4: JIT on class methods</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">FinistR : bootcamp R à Roscoff</h1>
<p class="subtitle lead">JIT with JAX</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Auteur·rice</div>
    <div class="quarto-title-meta-contents">
             <p>Hugo Gangloff </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>JAX is a Python library, basically a wrapper around numpy for efficient scientific programming: automatic differentiation, parallelization, JIT, etc. Many numpy functions are rewritten in a low level API called LAX. It then uses the XLA compiler to opitmization computations, see <a href="https://jax.readthedocs.io/en/latest/notebooks/thinking_in_jax.html#numpy-lax-xla-jax-api-layering">#numpy-lax-xla-jax-api-layering</a></p>
<p><strong>This tutorial is a non exhaustive but dense introduction to JAX, especially JIT compilation with JAX. We try to point the reader to the main concepts with a lot of redirections to external resources and to JAX documentation.</strong></p>
<section id="jit-with-jax" class="level2">
<h2 class="anchored" data-anchor-id="jit-with-jax">JIT with JAX</h2>
<p>A practical definition of JIT compilation can be found in <a href="https://jax.readthedocs.io/en/latest/index.html">JAX documentation</a>:</p>
<blockquote class="blockquote">
<p>When we jit-compile a function, we usually want to compile a version of the function that works for many different argument values, so that we can cache and reuse the compiled code. That way we don’t have to re-compile on each function evaluation.</p>
</blockquote>
<blockquote class="blockquote">
<p>For example, if we evaluate an <code>@jit</code> function on the array <code>jnp.array([1., 2., 3.], jnp.float32)</code>, we might want to compile code that we can reuse to evaluate the function on <code>jnp.array([4., 5., 6.], jnp.float32)</code> to save on compile time.</p>
</blockquote>
<blockquote class="blockquote">
<p>By default JAX executes operations one at a time, in sequence. Using a just-in-time (JIT) compilation decorator, sequences of operations can be optimized together and run at once.</p>
</blockquote>
<p><strong>In this tutorial we explore JAX JIT compilation on the same algorithm of the PLN model</strong> as coded in <a href="https://stateofther.github.io/finistR2023/torch_Python-PLN.html">the PLN in pytorch tutorial</a>. Also, this tutorial is to be compared with <a href="https://stateofther.github.io/finistR2023/jit-example-pln.html">JIT compilation in pytorch</a>.</p>
<p>First, we make the necessary imports</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#os.environ['CUDA_VISIBLE_DEVICES'] = '' # uncomment to force CPU</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyPLNmodels</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyPLNmodels.models <span class="im">import</span> PlnPCAcollection, Pln</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyPLNmodels.oaks <span class="im">import</span> load_oaks</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optax</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>jax.config.update(<span class="st">"jax_enable_x64"</span>, <span class="va">False</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(jax.devices())</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>myfloat <span class="op">=</span> np.float32</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>[gpu(id=0)]</code></pre>
<p><strong>Note</strong>: We use a GPU since JIT compilation is particularly efficient on GPU.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>oaks <span class="op">=</span> load_oaks()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> np.asarray(oaks[<span class="st">'counts'</span>]).astype(myfloat)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> np.repeat(Y, <span class="dv">100</span>, axis<span class="op">=</span><span class="dv">0</span>) <span class="co"># make data bigger to feel the speed up</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>O <span class="op">=</span> np.log(oaks[<span class="st">'offsets'</span>]).astype(myfloat)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>O <span class="op">=</span> np.repeat(O, <span class="dv">100</span>, axis<span class="op">=</span><span class="dv">0</span>) <span class="co"># make data bigger to feel the speed up</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.ones([Y.shape[<span class="dv">0</span>],<span class="dv">1</span>]).astype(myfloat)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>N_iter <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">1e-4</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="jax-without-jit" class="level3">
<h3 class="anchored" data-anchor-id="jax-without-jit">JAX without JIT</h3>
<p>This section does not use any kind of jitting. This is our baseline.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _log_stirling(integer):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    integer_ <span class="op">=</span> integer <span class="op">+</span> (integer <span class="op">==</span> <span class="dv">0</span>)  <span class="co"># Replace 0 with 1 since 0! = 1!</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.log(jnp.sqrt(<span class="dv">2</span> <span class="op">*</span> jnp.pi <span class="op">*</span> integer_)) <span class="op">+</span> integer_ <span class="op">*</span> jnp.log(integer_ <span class="op">/</span> jnp.exp(<span class="dv">1</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PLN:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, Y, O, X): </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Y <span class="op">=</span> Y</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.O <span class="op">=</span> O</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X <span class="op">=</span> X</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n, <span class="va">self</span>.p <span class="op">=</span> Y.shape</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Variational parameters</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.M <span class="op">=</span> jnp.full(Y.shape, <span class="fl">0.0</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.S <span class="op">=</span> jnp.full(Y.shape, <span class="fl">1.0</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Model parameters</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.B <span class="op">=</span> jnp.zeros((<span class="va">self</span>.d, <span class="va">self</span>.p))</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Sigma <span class="op">=</span> jnp.eye(<span class="va">self</span>.p)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Omega <span class="op">=</span> jnp.eye(<span class="va">self</span>.p)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_Sigma(<span class="va">self</span>, n, M, S) :</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">/</span>n <span class="op">*</span> (M.T <span class="op">@</span> M <span class="op">+</span> jnp.diag(jnp.<span class="bu">sum</span>(S<span class="op">**</span><span class="dv">2</span>, axis<span class="op">=</span><span class="dv">0</span>)))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_ELBO(<span class="va">self</span>, optim_params):</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>      B, M, S <span class="op">=</span> optim_params</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      S2 <span class="op">=</span> jnp.square(S)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      XB <span class="op">=</span> <span class="va">self</span>.X <span class="op">@</span> B</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      A <span class="op">=</span> jnp.exp(<span class="va">self</span>.O <span class="op">+</span> M <span class="op">+</span> XB <span class="op">+</span> S2<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      elbo <span class="op">=</span> <span class="va">self</span>.n<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> jnp.log(jnp.linalg.det(<span class="va">self</span>.Omega))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>      elbo <span class="op">+=</span> jnp.<span class="bu">sum</span>(<span class="op">-</span> A <span class="op">+</span> <span class="va">self</span>.Y <span class="op">*</span> (<span class="va">self</span>.O <span class="op">+</span> M <span class="op">+</span> XB) <span class="op">+</span> <span class="fl">.5</span> <span class="op">*</span> jnp.log(S2))</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>      elbo <span class="op">-=</span> <span class="fl">.5</span> <span class="op">*</span> jnp.trace(M.T <span class="op">@</span> M <span class="op">+</span> jnp.diag(jnp.<span class="bu">sum</span>(S2, axis<span class="op">=</span><span class="dv">0</span>)) <span class="op">@</span> <span class="va">self</span>.Omega)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>      elbo <span class="op">+=</span> <span class="fl">.5</span> <span class="op">*</span> <span class="va">self</span>.n <span class="op">*</span> <span class="va">self</span>.p  <span class="op">-</span> jnp.<span class="bu">sum</span>(_log_stirling(<span class="va">self</span>.Y))</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">-</span>elbo</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, N_iter, lr, tol <span class="op">=</span> <span class="fl">1e-8</span>) :</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        ELBO <span class="op">=</span> jnp.zeros(N_iter)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optax.chain(</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>            <span class="co">#adam(learning_rate=lr)</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>            optax.scale_by_radam(),</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>            optax.scale(<span class="op">-</span><span class="fl">1.0</span>),</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            optax.clip(<span class="fl">0.1</span>),</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        opt_state <span class="op">=</span> optimizer.init((<span class="va">self</span>.B, <span class="va">self</span>.M, <span class="va">self</span>.S))</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N_iter):</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>            loss_value, grads <span class="op">=</span> jax.value_and_grad(</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.get_ELBO, <span class="dv">0</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>            )((<span class="va">self</span>.B, <span class="va">self</span>.M, <span class="va">self</span>.S))</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>            updates, opt_state <span class="op">=</span> optimizer.update(grads, opt_state, (<span class="va">self</span>.B, <span class="va">self</span>.M, <span class="va">self</span>.S))</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            optim_params <span class="op">=</span> optax.apply_updates((<span class="va">self</span>.B, <span class="va">self</span>.M, <span class="va">self</span>.S), updates)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.B, <span class="va">self</span>.M, <span class="va">self</span>.S <span class="op">=</span> optim_params</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="co">## update parameters with close form</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.Sigma <span class="op">=</span> <span class="va">self</span>.get_Sigma(<span class="va">self</span>.n, <span class="va">self</span>.M, <span class="va">self</span>.S)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.Omega <span class="op">=</span> jnp.linalg.inv(<span class="va">self</span>.Sigma)</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>            objective <span class="op">=</span> loss_value</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>            ELBO <span class="op">=</span> ELBO.at[i].<span class="bu">set</span>(objective)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ELBO</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Have a look a the way we update the ELBO vector in the previous functions. This is because JAX arrays are immutable <a href="https://jax.readthedocs.io/en/latest/notebooks/Common_Gotchas_in_JAX.html#in-place-updates">#in-place-updates</a></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>pln <span class="op">=</span> PLN(Y, O, X)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> jax.default_device(jax.devices(<span class="st">'cpu'</span>)[<span class="dv">0</span>]): <span class="co"># as opposed to the subsequent jitted versions of the code, running this code do</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    jaxELBO_no_jit <span class="op">=</span> jax.block_until_ready(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        pln.fit(N_iter, lr, tol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>CPU times: user 10min 53s, sys: 21min 15s, total: 32min 8s
Wall time: 2min</code></pre>
</section>
<section id="jit-with-jax-level-1-jax.jit" class="level3">
<h3 class="anchored" data-anchor-id="jit-with-jax-level-1-jax.jit">JIT with JAX level 1: <code>jax.jit</code></h3>
<p>In this section, we will jit the functions used in the optimization process. Since it is not straightforward to JIT compilation class methods (see subsequent section), we will not use a class anymore.</p>
<p>Thus, we first create an independant function to initialize variables.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_params(Y, O, X): </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    n, p <span class="op">=</span> Y.shape</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Variational parameters</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> jnp.full(Y.shape, <span class="fl">0.0</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> jnp.full(Y.shape, <span class="fl">1.0</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Model parameters</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> jnp.zeros((d, p))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> jnp.eye(p)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    Omega <span class="op">=</span> jnp.eye(p)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n, p, d, M, S, B, Sigma, Omega</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s create the jitted functions. Note that <code>_log_stirling</code> will be automatically jitted when called the jitted <code>get_ELBO</code>. The actual <em>Just In Time</em> compilation will actually happen at the first execution of the jitted function. Note that the call <code>jax.jit()</code> is equivalent to using the decorator <code>@jax.jit</code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _log_stirling(integer):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    integer_ <span class="op">=</span> integer <span class="op">+</span> (integer <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.log(jnp.sqrt(<span class="dv">2</span> <span class="op">*</span> jnp.pi <span class="op">*</span> integer_)) <span class="op">+</span> integer_ <span class="op">*</span> jnp.log(integer_ <span class="op">/</span> jnp.exp(<span class="dv">1</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ELBO(optim_params, other_params): </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    B, M, S <span class="op">=</span> optim_params[<span class="st">'B'</span>], optim_params[<span class="st">'M'</span>], optim_params[<span class="st">'S'</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    X, O, n, Omega, Y, p <span class="op">=</span> (other_params[<span class="st">'X'</span>], other_params[<span class="st">'O'</span>], </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        other_params[<span class="st">'n'</span>], other_params[<span class="st">'Omega'</span>], other_params[<span class="st">'Y'</span>],</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        other_params[<span class="st">'p'</span>])</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    S2 <span class="op">=</span> jnp.square(S)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    XB <span class="op">=</span> X <span class="op">@</span> B</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> jnp.exp(O <span class="op">+</span> M <span class="op">+</span> XB <span class="op">+</span> S2<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    elbo <span class="op">=</span> <span class="fl">0.</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    elbo <span class="op">=</span> n <span class="op">/</span> <span class="dv">2</span> <span class="op">*</span> jnp.log(jnp.linalg.det(Omega))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    elbo <span class="op">+=</span> jnp.<span class="bu">sum</span>(<span class="op">-</span> A <span class="op">+</span> Y <span class="op">*</span> (O <span class="op">+</span> M <span class="op">+</span> XB) <span class="op">+</span> <span class="fl">.5</span> <span class="op">*</span> jnp.log(S2))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    elbo <span class="op">-=</span> <span class="fl">.5</span> <span class="op">*</span> jnp.trace(M.T <span class="op">@</span> M <span class="op">+</span> jnp.diag(jnp.<span class="bu">sum</span>(S2, axis <span class="op">=</span> <span class="dv">0</span>)) <span class="op">@</span> Omega)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    elbo <span class="op">+=</span> <span class="fl">.5</span> <span class="op">*</span> n <span class="op">*</span> p  <span class="op">-</span> jnp.<span class="bu">sum</span>(_log_stirling(Y))</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>elbo</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>jit_loss_and_grad <span class="op">=</span> jax.jit(jax.value_and_grad(get_ELBO, <span class="dv">0</span>)) <span class="co"># JIT !</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_Sigma(n, M, S) :</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">/</span>n <span class="op">*</span> (M.T <span class="op">@</span> M <span class="op">+</span> jnp.diag(jnp.<span class="bu">sum</span>(S<span class="op">**</span><span class="dv">2</span>, axis <span class="op">=</span> <span class="dv">0</span>)))</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>jit_getSigma <span class="op">=</span> jax.jit(get_Sigma) <span class="co"># JIT !</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>jit_inv <span class="op">=</span> jax.jit(jnp.linalg.inv) <span class="co"># JIT !</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the following, each function inside the for loop is jitted but the for loop is not jitted itself; it is inefficient to do so in JAX mostly due to the long compilation time it would induce, see <a href="https://jax.readthedocs.io/en/latest/faq.html#jit-decorated-function-is-very-slow-to-compile">#jit-decorated-function-is-very-slow-to-compile</a>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jaxfit1(optim_params, other_params, N_iter, lr, tol <span class="op">=</span> <span class="fl">1e-8</span>) :</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    ELBO <span class="op">=</span> jnp.zeros(N_iter)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optax.chain(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">#adam(learning_rate=lr)</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        optax.scale_by_radam(),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        optax.scale(<span class="op">-</span><span class="fl">1.0</span>),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        optax.clip(<span class="fl">0.1</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    opt_state <span class="op">=</span> optimizer.init(optim_params)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    objective0 <span class="op">=</span> jnp.inf</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    update <span class="op">=</span> jax.jit(optimizer.update)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    apply_updates <span class="op">=</span> jax.jit(optax.apply_updates)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N_iter):</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        loss_value, grads <span class="op">=</span> jit_loss_and_grad(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            optim_params,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            other_params</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        updates, opt_state <span class="op">=</span> update(grads, opt_state, optim_params)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        optim_params <span class="op">=</span> apply_updates(optim_params, updates)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">## update parameters with close form</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        other_params[<span class="st">'Sigma'</span>] <span class="op">=</span> jit_getSigma(other_params[<span class="st">'n'</span>], optim_params[<span class="st">'M'</span>],</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        optim_params[<span class="st">'S'</span>])</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        other_params[<span class="st">'Omega'</span>] <span class="op">=</span> jit_inv(other_params[<span class="st">'Sigma'</span>])</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        objective <span class="op">=</span> loss_value</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        ELBO <span class="op">=</span> ELBO.at[i].<span class="bu">set</span>(objective)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ELBO</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Initialize the data for JAX</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> jnp.asarray(Y)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>O <span class="op">=</span> jnp.asarray(O)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> jnp.array(X)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>n, p, d, M, S, B, Sigma, Omega <span class="op">=</span> init_params(Y, O, X)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>optim_params <span class="op">=</span> {<span class="st">'B'</span>:B, <span class="st">'M'</span>:M, <span class="st">'S'</span>:S}</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>other_params <span class="op">=</span> {<span class="st">'X'</span>:X, <span class="st">'O'</span>:O, <span class="st">'n'</span>:n, <span class="st">'Omega'</span>:Omega, <span class="st">'Y'</span>:Y, <span class="st">'p'</span>:p, <span class="st">'Sigma'</span>:Sigma}</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and run the learning process:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>jaxELBO1 <span class="op">=</span> jax.block_until_ready(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    jaxfit1(optim_params, other_params, N_iter, lr<span class="op">=</span>lr, tol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>CPU times: user 3.87 s, sys: 500 ms, total: 4.37 s
Wall time: 4.13 s</code></pre>
<p><strong>Note</strong>: Because of the complex JAX internal mechanics, benchmarking with JAX should be done with caution <a href="https://jax.readthedocs.io/en/latest/async_dispatch.html">https://jax.readthedocs.io/en/latest/async_dispatch.html</a></p>
</section>
<section id="jit-with-jax-level-2-jax.lax.scan" class="level3">
<h3 class="anchored" data-anchor-id="jit-with-jax-level-2-jax.lax.scan">JIT with JAX level 2: <code>jax.lax.scan</code></h3>
<p>In this section, we add resort to <code>jax.lax.scan</code>, which is the standard way to write <code>for</code> loops in JAX. <code>jax.lax.scan</code> automatically JIT compiles its content, it’s not necessary to add the calls to <code>jax.jit</code> here.</p>
<p>For a complete tutorial on <code>jax.lax.scan</code> see <a href="https://ericmjl.github.io/dl-workshop/02-jax-idioms/02-loopy-carry.html">https://ericmjl.github.io/dl-workshop/02-jax-idioms/02-loopy-carry.html</a></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jaxfit2(optim_params, other_params, N_iter, lr, tol <span class="op">=</span> <span class="fl">1e-8</span>) :</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optax.chain(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">#adam(learning_rate=lr)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        optax.scale_by_radam(),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        optax.scale(<span class="op">-</span><span class="fl">1.0</span>),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        optax.clip(<span class="fl">0.1</span>),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    opt_state <span class="op">=</span> optimizer.init(optim_params)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scan_fun(carry, _):</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        optim_params <span class="op">=</span> carry[<span class="st">'optim_params'</span>]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        other_params <span class="op">=</span> carry[<span class="st">'other_params'</span>]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        loss_value, grads <span class="op">=</span> jax.value_and_grad(get_ELBO)(optim_params,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        other_params)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        updates, opt_state <span class="op">=</span> optimizer.update(grads, carry[<span class="st">'opt_state'</span>])</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        optim_params <span class="op">=</span> optax.apply_updates(optim_params, updates)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">## update parameters with close form</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        other_params[<span class="st">'Sigma'</span>] <span class="op">=</span> get_Sigma(other_params[<span class="st">'n'</span>], optim_params[<span class="st">'M'</span>],</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        optim_params[<span class="st">'S'</span>])</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        other_params[<span class="st">'Omega'</span>] <span class="op">=</span> jnp.linalg.inv(other_params[<span class="st">'Sigma'</span>])</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'optim_params'</span>] <span class="op">=</span> optim_params</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'other_params'</span>] <span class="op">=</span> other_params</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'opt_state'</span>] <span class="op">=</span> opt_state</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> carry, loss_value</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    carry, ELBO <span class="op">=</span> jax.lax.scan(</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        scan_fun,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"optim_params"</span>:optim_params,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"other_params"</span>:other_params,</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">'opt_state'</span>:opt_state</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        jnp.arange(N_iter)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ELBO</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Initialize the data for JAX:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> jnp.asarray(Y)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>O <span class="op">=</span> jnp.asarray(O)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> jnp.array(X)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>n, p, d, M, S, B, Sigma, Omega <span class="op">=</span> init_params(Y, O, X)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>optim_params <span class="op">=</span> {<span class="st">'B'</span>:B, <span class="st">'M'</span>:M, <span class="st">'S'</span>:S}</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>other_params <span class="op">=</span> {<span class="st">'X'</span>:X, <span class="st">'O'</span>:O, <span class="st">'n'</span>:n, <span class="st">'Omega'</span>:Omega, <span class="st">'Y'</span>:Y, <span class="st">'p'</span>:p, <span class="st">'Sigma'</span>:Sigma}</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Note</strong>: Let’s us try the Ahead Of Time (AOT) compilation where the compilation is done beforehand in a particular explicit step and not at the first execution of the function (as in classical JIT compilation). By doing so we can get an estimate of the compilation time, which is, in our case, not a bottleneck.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>lowered <span class="op">=</span> jax.jit(jaxfit2, static_argnums<span class="op">=</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)).lower(optim_params,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>other_params, N_iter, lr<span class="op">=</span>lr, tol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>compiled <span class="op">=</span> lowered.<span class="bu">compile</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>CPU times: user 708 ms, sys: 40.1 ms, total: 748 ms
Wall time: 502 ms</code></pre>
<p>Let’s run the complete fit (including compilation)</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>jaxELBO2 <span class="op">=</span> jax.block_until_ready(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    jaxfit2(optim_params, other_params, N_iter, lr, tol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>CPU times: user 1.97 s, sys: 1.08 s, total: 3.05 s
Wall time: 2.83 s</code></pre>
</section>
<section id="jit-with-jax-level-3-can-we-jit-everything" class="level3">
<h3 class="anchored" data-anchor-id="jit-with-jax-level-3-can-we-jit-everything">JIT with JAX level 3: can we jit everything?</h3>
<p><strong>Now we will dive into some of the sharp bits of JAX</strong>. Let’s try to reuse the above jitted functions with a simple PLN <code>class</code> which acts like a container as we did in the tutorial <a href="https://stateofther.github.io/finistR2023/jit-example-pln.html">JIT compilation in pytorch</a>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PLN_container:</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, Y, O, X): </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Y <span class="op">=</span> Y</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.O <span class="op">=</span> O</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X <span class="op">=</span> X</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n, <span class="va">self</span>.p <span class="op">=</span> Y.shape</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n <span class="op">=</span> <span class="va">self</span>.n</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.p <span class="op">=</span> <span class="va">self</span>.p</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Variational parameters</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.M <span class="op">=</span> jnp.full(Y.shape, <span class="fl">0.0</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.S <span class="op">=</span> jnp.full(Y.shape, <span class="fl">1.0</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Model parameters</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.B <span class="op">=</span> jnp.zeros((<span class="va">self</span>.d, <span class="va">self</span>.p))</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Sigma <span class="op">=</span> jnp.eye(<span class="va">self</span>.p)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Omega <span class="op">=</span> jnp.eye(<span class="va">self</span>.p)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we would like to adapt the <code>scan_fun</code> as:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jaxfit3(pln, N_iter, lr, tol <span class="op">=</span> <span class="fl">1e-8</span>) :</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optax.chain(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">#adam(learning_rate=lr)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        optax.scale_by_radam(),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        optax.scale(<span class="op">-</span><span class="fl">1.0</span>),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        optax.clip(<span class="fl">0.1</span>),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    opt_state <span class="op">=</span> optimizer.init({<span class="st">'B'</span>:pln.B, <span class="st">'M'</span>:pln.M, <span class="st">'S'</span>:pln.S})</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scan_fun(carry, _):</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> carry[<span class="st">'PLN'</span>]</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        loss_value, grads <span class="op">=</span> jax.value_and_grad(get_ELBO)(</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'B'</span>:pln.B, <span class="st">'M'</span>:pln.M, <span class="st">'S'</span>:pln.S},</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'X'</span>:pln.X, <span class="st">'O'</span>:pln.O, <span class="st">'n'</span>:pln.n, <span class="st">'Omega'</span>:pln.Omega,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Y'</span>:pln.Y, <span class="st">'p'</span>:pln.p, <span class="st">'Sigma'</span>:pln.Sigma}</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        updates, opt_state <span class="op">=</span> optimizer.update(grads, carry[<span class="st">'opt_state'</span>])</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        updated_params <span class="op">=</span> optax.apply_updates(</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'B'</span>:pln.B, <span class="st">'M'</span>:pln.M, <span class="st">'S'</span>:pln.S},</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>            updates)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        pln.B <span class="op">=</span> updated_params[<span class="st">'B'</span>]</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        pln.M <span class="op">=</span> updated_params[<span class="st">'M'</span>]</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        pln.S <span class="op">=</span> updated_params[<span class="st">'S'</span>]</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">## update parameters with close form</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        pln.Sigma <span class="op">=</span> get_Sigma(pln.N, pln.M, pln.S)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        pln.Omega <span class="op">=</span> jnp.linalg.inv(pln.Sigma)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'PLN'</span>] <span class="op">=</span> pln</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'opt_state'</span>] <span class="op">=</span> opt_state</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> carry, loss_value</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    carry, ELBO <span class="op">=</span> jax.lax.scan(</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        scan_fun,</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"PLN"</span>:pln,</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">'opt_state'</span>:opt_state</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        jnp.arange(N_iter)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ELBO</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And finally, we would like to start the optimization with:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>pln_container <span class="op">=</span> PLN_container(Y, O, X)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>jaxELBO3 <span class="op">=</span> jax.block_until_ready(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    jaxfit3(pln_container, N_iter, lr, tol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we run the previous lines, we get an expected error: <code>class PLN is not a valid JAX type</code>. Recall that the <code>scan</code> loop automatically JIT compiles its content and we cannot JIT compile function whose arguments are custom classes without specific treatment that we will discover in the next subsection. <strong>But what is a valid JAX type?</strong> From the <a href="https://jax.readthedocs.io/en/latest/_autosummary/jax.jit.html">documentation</a> of <code>jax.jit</code> we read:</p>
<blockquote class="blockquote">
<p>The arguments and return value of fun [the jitted function] should be arrays, scalars, or (nested) standard Python containers (tuple/list/dict) [pytrees] thereof [which themselves contain arrays or scalars].</p>
</blockquote>
<p>The variety of containers that JAX can handle are refered to with the term <strong><a href="https://jax.readthedocs.io/en/latest/pytrees.html">Pytrees</a></strong>.</p>
<p>We also read about <strong>pure function</strong> and <strong>static arguments</strong>, more on that below !</p>
<p>For the moment, as the class PLN acts as a simple container, a common work around can be to use a Python <strong>native and jittable</strong> <code>namedtuple</code> class, or a <code>NamedTuple</code> from <code>typing</code> library which improves the class creation. See this introduction to <code>NamedTuple</code>: <a href="https://www.geeksforgeeks.org/typing-namedtuple-improved-namedtuples/">https://www.geeksforgeeks.org/typing-namedtuple-improved-namedtuples/</a>. NamedTuples are immutable class, so if we want to update one of its attributes we need to use the <code>_replace()</code> method which returns a new object! Note that we can use <code>jax.typing</code> to provide JAX related type hints <a href="https://jax.readthedocs.io/en/latest/jax.typing.html">#jax.typing</a>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> NamedTuple</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.typing <span class="im">import</span> ArrayLike</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PLN(NamedTuple):</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    Y: ArrayLike</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    O: ArrayLike</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    X: ArrayLike</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    n: <span class="bu">int</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    p: <span class="bu">int</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    d: <span class="bu">int</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    M: ArrayLike</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    S: ArrayLike</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    B: ArrayLike</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    Sigma: ArrayLike</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    Omega: ArrayLike</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>pln_namedtuple <span class="op">=</span> PLN(</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    Y, O, X,</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    Y.shape[<span class="dv">0</span>], Y.shape[<span class="dv">1</span>], X.shape[<span class="dv">1</span>],</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    jnp.full(Y.shape, <span class="fl">0.0</span>), jnp.full(Y.shape, <span class="fl">1.0</span>),</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    jnp.zeros((X.shape[<span class="dv">1</span>], Y.shape[<span class="dv">1</span>])), jnp.eye(Y.shape[<span class="dv">1</span>]),</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    jnp.eye(Y.shape[<span class="dv">1</span>]))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s adapt the <code>scan_fun</code> function</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jaxfit3(pln, N_iter, lr, tol <span class="op">=</span> <span class="fl">1e-8</span>) :</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optax.chain(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">#adam(learning_rate=lr)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        optax.scale_by_radam(),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        optax.scale(<span class="op">-</span><span class="fl">1.0</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        optax.clip(<span class="fl">0.1</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    opt_state <span class="op">=</span> optimizer.init({<span class="st">'B'</span>:pln.B, <span class="st">'M'</span>:pln.M, <span class="st">'S'</span>:pln.S})</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scan_fun(carry, _):</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> carry[<span class="st">'PLN'</span>]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        loss_value, grads <span class="op">=</span> jax.value_and_grad(get_ELBO)(</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'B'</span>:pln.B, <span class="st">'M'</span>:pln.M, <span class="st">'S'</span>:pln.S},</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'X'</span>:pln.X, <span class="st">'O'</span>:pln.O, <span class="st">'n'</span>:pln.n, <span class="st">'Omega'</span>:pln.Omega,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Y'</span>:pln.Y, <span class="st">'p'</span>:pln.p, <span class="st">'Sigma'</span>:pln.Sigma}</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        updates, opt_state <span class="op">=</span> optimizer.update(grads, carry[<span class="st">'opt_state'</span>])</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        updated_params <span class="op">=</span> optax.apply_updates(</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'B'</span>:pln.B, <span class="st">'M'</span>:pln.M, <span class="st">'S'</span>:pln.S},</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>            updates)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> pln._replace(B<span class="op">=</span>updated_params[<span class="st">'B'</span>])</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> pln._replace(M<span class="op">=</span>updated_params[<span class="st">'M'</span>])</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> pln._replace(S<span class="op">=</span>updated_params[<span class="st">'S'</span>])</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">## update parameters with close form</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> pln._replace(Sigma<span class="op">=</span>get_Sigma(pln.n, pln.M, pln.S))</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> pln._replace(Omega<span class="op">=</span>jnp.linalg.inv(pln.Sigma))</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'PLN'</span>] <span class="op">=</span> pln</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'opt_state'</span>] <span class="op">=</span> opt_state</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> carry, loss_value</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    carry, ELBO <span class="op">=</span> jax.lax.scan(</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        scan_fun,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"PLN"</span>:pln,</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">'opt_state'</span>:opt_state</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        jnp.arange(N_iter)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ELBO</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>jaxELBO3 <span class="op">=</span> jax.block_until_ready(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    jaxfit3(pln_namedtuple, N_iter, lr, tol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>CPU times: user 2.34 s, sys: 831 ms, total: 3.17 s
Wall time: 2.91 s</code></pre>
<p>Ok, our code works but it is getting a little bit messy: we would like more than containers but real classes, with real methods! That’s what we will see in the next section.</p>
<p>First, let’s try to summarize the <strong>main points of JIT compiling functions with JAX</strong>:</p>
<ul>
<li><em>Not all JAX code can be JIT compiled, as <strong>it requires array shapes to be static &amp; known at compile time</strong>.</em> <a href="https://jax.readthedocs.io/en/latest/notebooks/thinking_in_jax.html#to-jit-or-not-to-jit">#to-jit-or-not-to-jit</a></li>
<li><em>JIT and other JAX transforms work by tracing a function to determine its effect on inputs of a specific shape and type. <strong>Variables that you don’t want <em>[or that cannot be traced because they are not of valid JAX type]</em> to be traced can be marked as static</strong></em> <a href="https://jax.readthedocs.io/en/latest/notebooks/thinking_in_jax.html#jit-mechanics-tracing-and-static-variables">#jit-mechanics-tracing-and-static-variables</a></li>
<li>Recall that JIT compilation in pytorch cannot handle dynamic shapes, control flows, etc. since it is lost when constructing the Intermediate Representation (IR) of the computational graph that is ued for jitting. The same behaviour happens in JAX when constructing the <code>jaxpr</code> which is the name of the IR in JAX, see <a href="https://jax.readthedocs.io/en/latest/jax-101/02-jitting.html#why-can-t-we-just-jit-everything">#why-can-t-we-just-jit-everything</a>. However, in JAX, <strong>there exists way to not lose all the control flows</strong>, to conserve conditional statements even inside the <code>jaxpr</code>, etc. Let’s mention the <code>static_argnums</code> decorator, the special <code>jax.lax.cond</code> function, etc. To find more about control flows and jit, see <a href="https://jax.readthedocs.io/en/latest/notebooks/Common_Gotchas_in_JAX.html#python-control-flow-jit">#python-control-flow-jit</a></li>
<li>In fact, JAX is asked to JIT compile a function, it will <em>trace</em> its arguments to create the jaxpr, more precisely <a href="https://jax.readthedocs.io/en/latest/jax-101/02-jitting.html">#jitting.html</a>:</li>
</ul>
<blockquote class="blockquote">
<p>When tracing, JAX wraps each argument by a tracer object. These tracers then record all JAX operations performed on them during the function call (which happens in regular Python). Then, JAX uses the tracer records to reconstruct the entire function. The output of that reconstruction is the jaxpr</p>
</blockquote>
<blockquote class="blockquote">
<p>The more specific information about the values we use in the trace, the more we can use standard Python control flow to express ourselves. However, being too specific means we can’t reuse the same traced function for other values. JAX solves this by tracing at different levels of abstraction for different purposes. For <code>jax.jit</code>, the default level is <code>ShapedArray</code> <strong>We understand that the arguments of a jitted function should be traceable as <code>ShapedArray</code> class, or be a Pytree with either 1.Pytree nodes or 2.leaf nodes being either traceable as a <code>ShapedArray</code> object or leaf nodes treated as <code>static</code> arguments.</strong> We saw above that scalars and arrays were the valid JAX types, it makes sense since scalars or arrays can be traced with ShapedArray objects.</p>
</blockquote>
<ul>
<li><strong>Note on static arguments:</strong></li>
</ul>
<blockquote class="blockquote">
<p>We can tell JAX to help itself to a less abstract tracer for a particular input by specifying static_argnums or static_argnames. The cost of this is that the resulting jaxpr is less flexible, so <strong>JAX will have to re-compile the function for every new value of the specified static input</strong>. It is only a good strategy if the function is guaranteed to get limited different values.</p>
</blockquote>
<ul>
<li>Last but not least, JAX requires the jitted functions to be pure, they cannot have any side effect <a href="https://jax.readthedocs.io/en/latest/notebooks/Common_Gotchas_in_JAX.html#pure-functions">#pure-functions</a>:</li>
</ul>
<blockquote class="blockquote">
<p>JAX transformation and compilation are designed to work only on Python functions that are <strong>functionally pure: all the input data is passed through the function parameters, all the results are output through the function results</strong>. A pure function will always return the same result if invoked with the same inputs.</p>
</blockquote>
<p><strong>JIT with JAX level 3.5: <em>dataclasses</em> and <em>pytrees</em></strong></p>
<p>Python developpers also love to use <code>dataclasses</code> as simple data structures. However they are not supported by default in JAX. Many libraries offer ways to also add <code>dataclasses</code> to the Pytrees JAX can handle: <a href="https://github.com/cgarciae/simple-pytree">simple-pytree</a>, <a href="https://github.com/NeilGirdhar/tjax">tjax</a>, <a href="https://github.com/brentyi/jax_dataclasses">jax_dataclasses</a>, <a href="https://github.com/deepmind/chex#dataclass-dataclasspy">chex dataclasses</a> etc.</p>
</section>
<section id="jit-with-jax-level-4-jit-on-class-methods" class="level3">
<h3 class="anchored" data-anchor-id="jit-with-jax-level-4-jit-on-class-methods">JIT with JAX level 4: JIT on class methods</h3>
<p>In this section, we study the canonical way to JIT compile class methods, a introduction to this technique can be found here: <a href="https://jax.readthedocs.io/en/latest/faq.html#how-to-use-jit-with-methods">#how-to-use-jit-with-methods</a>. Note that the recipe we give here should be seen from the viewpoint of Pytrees, since a class is always somehow a container. We therefore want to <a href="https://jax.readthedocs.io/en/latest/pytrees.html">#extending-pytrees</a>. The main elements of making custom class jittable are:</p>
<ol type="1">
<li>Decorate the class with <code>@register_pytree_node_class</code></li>
<li>Add the <code>tree_flatten</code> method</li>
<li>Add the <code>tree_unflatten</code> method</li>
</ol>
<p>We here can draw a link with the elements we noted in the previous section: <strong>we make our custom class a Pytree, so that it can be jitted provided it contains attributes being 1.Pytree nodes or 2.leaf nodes being either inherited <code>ShapedArray</code> object or leaf nodes treated as <code>static</code> arguments!</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.tree_util <span class="im">import</span> register_pytree_node_class</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.typing <span class="im">import</span> ArrayLike</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="at">@register_pytree_node_class</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PLN:</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    Y: ArrayLike</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    O: ArrayLike</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    X: ArrayLike</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    n: <span class="bu">int</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    p: <span class="bu">int</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    d: <span class="bu">int</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    M: ArrayLike</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    S: ArrayLike</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    B: ArrayLike</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    Sigma: ArrayLike</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    Omega: ArrayLike</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, Y, O, X): </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Y <span class="op">=</span> Y</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.O <span class="op">=</span> O</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X <span class="op">=</span> X</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n, <span class="va">self</span>.p <span class="op">=</span> Y.shape</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n <span class="op">=</span> <span class="va">self</span>.n</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.p <span class="op">=</span> <span class="va">self</span>.p</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Variational parameters</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.M <span class="op">=</span> jnp.full(Y.shape, <span class="fl">0.0</span>)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.S <span class="op">=</span> jnp.full(Y.shape, <span class="fl">1.0</span>)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Model parameters</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.B <span class="op">=</span> jnp.zeros((<span class="va">self</span>.d, <span class="va">self</span>.p))</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Sigma <span class="op">=</span> jnp.eye(<span class="va">self</span>.p)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Omega <span class="op">=</span> jnp.eye(<span class="va">self</span>.p)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_optim_params(<span class="va">self</span>):</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'B'</span>:<span class="va">self</span>.B, <span class="st">'M'</span>:<span class="va">self</span>.M, <span class="st">'S'</span>:<span class="va">self</span>.S}</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_optim_params(<span class="va">self</span>, op):</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k, v <span class="kw">in</span> op.items():</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>            <span class="bu">vars</span>(<span class="va">self</span>)[k] <span class="op">=</span> v</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_other_params(<span class="va">self</span>):</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">'X'</span>:<span class="va">self</span>.X, <span class="st">'O'</span>:<span class="va">self</span>.O, <span class="st">'n'</span>:<span class="va">self</span>.n, <span class="st">'Omega'</span>:<span class="va">self</span>.Omega,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Y'</span>:<span class="va">self</span>.Y, <span class="st">'p'</span>:<span class="va">self</span>.p, <span class="st">'Sigma'</span>:<span class="va">self</span>.Sigma</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_other_params(<span class="va">self</span>, op):</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k, v <span class="kw">in</span> op.items():</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">vars</span>(<span class="va">self</span>)[k] <span class="op">=</span> v</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_Sigma(<span class="va">self</span>):</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>        pln.Sigma <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> <span class="va">self</span>.n <span class="op">*</span> (<span class="va">self</span>.M.T <span class="op">@</span> <span class="va">self</span>.M <span class="op">+</span> jnp.diag(jnp.<span class="bu">sum</span>(<span class="va">self</span>.S <span class="op">**</span> <span class="dv">2</span>, axis <span class="op">=</span> <span class="dv">0</span>)))</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_Omega(<span class="va">self</span>):</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>        pln.Omega <span class="op">=</span> jnp.linalg.inv(<span class="va">self</span>.Sigma)</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tree_flatten(<span class="va">self</span>):</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> (</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.B, <span class="va">self</span>.M, <span class="va">self</span>.S, <span class="va">self</span>.Sigma, <span class="va">self</span>.Omega,</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>        )  <span class="co"># arrays / dynamic values</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>        aux_data <span class="op">=</span> {</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Y'</span>:<span class="va">self</span>.Y, <span class="st">'O'</span>:<span class="va">self</span>.O, <span class="st">'X'</span>:<span class="va">self</span>.X,</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n'</span>:<span class="va">self</span>.n, <span class="st">'p'</span>:<span class="va">self</span>.p, <span class="st">'d'</span>:<span class="va">self</span>.d</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>        }  <span class="co"># static values</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (children, aux_data)</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tree_unflatten(cls, aux_data, children):</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>        (B, M, S, Sigma, Omega) <span class="op">=</span> children</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> cls(</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>            aux_data[<span class="st">'Y'</span>], aux_data[<span class="st">'O'</span>], aux_data[<span class="st">'X'</span>]</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>        obj.B <span class="op">=</span> B</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>        obj.M <span class="op">=</span> M</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>        obj.S <span class="op">=</span> S</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s adapt the <code>scan_fun</code> function, we are now free to use our new class methods</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jaxfit4(pln, N_iter, lr, tol <span class="op">=</span> <span class="fl">1e-8</span>) :</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optax.chain(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">#adam(learning_rate=lr)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        optax.scale_by_radam(),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        optax.scale(<span class="op">-</span><span class="fl">1.0</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        optax.clip(<span class="fl">0.1</span>),</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    opt_state <span class="op">=</span> optimizer.init(pln.get_optim_params())</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scan_fun(carry, k):</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        pln <span class="op">=</span> carry[<span class="st">'PLN'</span>]</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        loss_value, grads <span class="op">=</span> jax.value_and_grad(get_ELBO)(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>            pln.get_optim_params(),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>            pln.get_other_params()</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        updates, opt_state <span class="op">=</span> optimizer.update(grads, carry[<span class="st">'opt_state'</span>])</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        optim_params <span class="op">=</span> optax.apply_updates(</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>            pln.get_optim_params(),</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>            updates</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        pln.set_optim_params(optim_params)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">## update parameters with close form</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        pln.update_Sigma()</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>        pln.update_Omega()</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'PLN'</span>] <span class="op">=</span> pln</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        carry[<span class="st">'opt_state'</span>] <span class="op">=</span> opt_state</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> carry, loss_value</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    carry, ELBO <span class="op">=</span> jax.lax.scan(</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        scan_fun,</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"PLN"</span>:pln,</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'opt_state'</span>:opt_state</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        jnp.arange(N_iter)</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ELBO</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>pln <span class="op">=</span> PLN(Y, O, X)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>jaxELBO4 <span class="op">=</span> jax.block_until_ready(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    jaxfit4(pln, N_iter, lr, tol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>CPU times: user 6.29 s, sys: 901 ms, total: 7.2 s
Wall time: 4.34 s</code></pre>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We check the results</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(jaxELBO_no_jit), label<span class="op">=</span><span class="st">'no jit'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(jaxELBO1), label<span class="op">=</span><span class="st">'jit level 1'</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(jaxELBO2), label<span class="op">=</span><span class="st">'jit level 2'</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(jaxELBO3), label<span class="op">=</span><span class="st">'jit level 3'</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(jaxELBO4), label<span class="op">=</span><span class="st">'jit level 4'</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>/tmp/ipykernel_54173/3050985271.py:1: RuntimeWarning: invalid value encountered in log
  plt.plot(np.log(jaxELBO_no_jit), label='no jit')
/tmp/ipykernel_54173/3050985271.py:2: RuntimeWarning: invalid value encountered in log
  plt.plot(np.log(jaxELBO1), label='jit level 1')
/tmp/ipykernel_54173/3050985271.py:3: RuntimeWarning: invalid value encountered in log
  plt.plot(np.log(jaxELBO2), label='jit level 2')
/tmp/ipykernel_54173/3050985271.py:4: RuntimeWarning: invalid value encountered in log
  plt.plot(np.log(jaxELBO3), label='jit level 3')</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/jit-example-pln-jax_files/elbo_graph.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<ul>
<li><strong>Jitting is more involved in JAX than with pytorch</strong>, the best performances require some specific JAX knowledge that we exposed in each subsection of this document.</li>
<li>When jitting with JAX we fall back on quite the same difficulties as when jitting with pytorch trace.</li>
<li>However, JAX offers clear ways to overcome the difficulties that pytorch tracing does not offer (scan, static_argnums, pytrees, …)</li>
<li>In this particular example on <strong>GPU</strong>, <strong>jitted JAX can perform twice as fast as jitted pytorch</strong>. But in this particular example on <strong>CPU</strong>, JAX is slower than pytorch; is it link with the points raised in <a href="https://jax.readthedocs.io/en/latest/faq.html#benchmarking-jax-code">#benchmarking-jax-code</a> ? However, this also recalls what we can often read online: JAX is particularly suited for GPU optimization. We need to test JAX on other examples involving neural networks, mini-batches, etc. in order to understand JAX potential on CPU optimization too.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>